---
title: "Normal Inverse Gamma model"
author: "Patrick Ding, James Dole, Naveed Merchant"
output: github_document
---

## Normal inverse gamma

$$
\begin{aligned}
x_1 \ldots x_n|\mu &\sim N(\mu, \sigma^2)
\\
\pi(\mu, \sigma^2) &\propto \frac{1}{\sigma^2}
\\
\mu, \sigma^2 | x_1 \ldots x_n &\sim 
  N\text{-}\Gamma^{-1}(\tau = \bar{x}, \lambda = n, 
  \alpha = (n+4)/2, \beta = \frac{1}{2}(\sum x_i^2 - n\bar{x}^2))
\\
\sigma^2|x_1 \ldots x_n &\sim \Gamma^{-1}(\alpha, \beta)
\\
\mu | x_1 \ldots x_n &\sim t_{2\alpha}\big(\tau, \beta/(\alpha\lambda)\big
\end{aligned}
$$

```{r}
dnig <- function(m, v, mu, lambda, alpha, bet) {
  sqrt(lambda / 2 * pi * v) * 
    ((bet ^ alpha) / (gamma(alpha))) * v ^ (- alpha - 1) *
    exp(- (2 * bet + lambda * (m - mu) ^ 2) / (2 * v ^ 2))
}
```

```{r warning=FALSE}
source("nig.R")
source("metropolis_hastings.R")
source("gibbs.R")
library(invgamma)

n <- 200
S <- 10000

x <- rnorm(n, 0, 5)
tau <- mean(x)
lambda <- n
alpha <- (n + 4) / 2
bet <- .5 * (sum(x ^ 2) - n * mean(x) ^ 2)

mu_mh_s <- 2
sigma_mh_s <- 10
nig_lik <- nig_likelihood(x)
nig_p <- nig_prior()
nig_prop <- nig_proposal(mu_mh_s, sigma_mh_s)
nig_prop_d <- nig_prop_density(mu_mh_s, sigma_mh_s)

nig_pot <- nig_U(x)
nig_grad <- nig_dU(x)

nig_mh <- metropolis_hastings(param_init = list(1, 10), 
                              likelihood = nig_lik, 
                              prior = nig_p, 
                              proposal = nig_prop, 
                              prop_density = nig_prop_d,
                              iters = S)
nig_gibbs <- gibbs(c(1, 10), S, nig_cond_mu(x), nig_cond_sigma(x))
nig_hmc <- hmc(param_init = c(1, 10), nig_pot, nig_grad, 
               .05, 50, S)

plot_grid <- seq(-4, 4, .01)
hist(nig_mh$samples[[1]][101:S, ], probability = TRUE, breaks = 100)
lines(plot_grid, 
      dt(sqrt(alpha * lambda / bet) * (plot_grid - tau) , df = 2 * alpha))

plot_grid <- seq(.01, 50, .01)
hist(nig_mh$samples[[2]][101:S, ], probability = TRUE, breaks = 25)
lines(plot_grid, dinvgamma(plot_grid, alpha, bet))

plot_grid <- seq(-2, 2, .01)
hist(nig_gibbs[, 1], breaks = 25, probability = TRUE)
lines(plot_grid, 
      dt(sqrt(alpha * lambda / bet) * (plot_grid - tau), df = 2 * alpha))

plot_grid <- seq(0, 60, .1)
hist(nig_gibbs[, 2], breaks = 25, xlim = c(0, 100), probability = TRUE)
lines(plot_grid, dinvgamma(plot_grid, alpha, bet))
```

